--- a/assets/game/shaders/chunkliquid.fsh
+++ b/assets/game/shaders/chunkliquid.fsh
@@ -1,4 +1,4 @@
-#version 330 core
+ï»¿#version 330 core
 
 uniform sampler2D terrainTex;
 uniform sampler2D depthTex;
@@ -26,6 +26,7 @@
 in vec3 fragNormal;
 flat in int skyExposed;
 
+
 in vec2 flowVectorf;
 in float glowLevel;
 
@@ -45,12 +46,12 @@
 vec2 droplethash3( vec2 p )
 {
     vec2 q = vec2(dot(p,vec2(127.1,311.7)), dot(p,vec2(269.5,183.3)));
-    return fract(sin(q)*43758.5453);
+	return fract(sin(q)*43758.5453);
 }
 
 float dropletnoise(in vec2 x)
 {
-    if (dropletIntensity < 0.001) return 0.;
+	if (dropletIntensity < 0.001) return 0.;
 	
     x *= dropletIntensity;
     
@@ -58,19 +59,19 @@
     vec2 f = fract(x);
 
 
-    float va = 0.0;
+	float va = 0.0;
     for( int j=-1; j<=1; j++ )
     for( int i=-1; i<=1; i++ )
     {
         vec2 g = vec2(float(i), float(j));
-        vec2 o = droplethash3(p + g);
-        vec2 r = g - f + o;
-        float d = length(r) / dropletIntensity;
+		vec2 o = droplethash3(p + g);
+		vec2 r = g - f + o;
+		float d = length(r) / dropletIntensity;
         
         float a = max(cos(d - waterWaveCounter * 2.7 + (o.x + o.y) * 5.0), 0.);
         a = smoothstep(0.99, 0.999, a);
-        
-        float ripple = mix(a, 0., d);
+
+		float ripple = mix(a, 0., d);
         va += max(ripple, 0.);
     }
 	
@@ -91,7 +92,9 @@
     // Make sure to use the red channel (and GL_RED target in your texture)
     outReveal.r = color.a; // Was *1.2 but that made lava more transparent :o
 	
-    outGlow = vec4(glowLevel, 0, 0, color.a);
+	float scatterAmt = calculateVolumetricScatter(fWorldPos);
+	
+    outGlow = vec4(glowLevel, scatterAmt, 0, color.a);
 }
 
 void main() 
@@ -164,7 +167,7 @@
 			float intensity = clamp(dot(fragNormal, vec3(0, 1, 0)), 0, 1) * 0.5;
 			float a = fragWorldPos.x + fragWorldPos.y - 1.5 * flowVectorf.x * waterFlowCounter;
 			float b = fragWorldPos.z - 1.5 * flowVectorf.y * waterFlowCounter;
-			
+
 			float diff = intensity * clamp(1 - diffTotal*1000 - gnoise(vec3(a*35, b*35, waterFlowCounter))/2 + gnoise(vec3(a*2, b*2, waterFlowCounter))/2, 0, 1);
 			float noise = intensity * (gnoise(vec3(a, b, waterFlowCounter)) + 0.5) / 2;
 			float rgbAdd = bright*(diff * 0.3 + noise/10);
@@ -174,70 +177,39 @@
 		} else {
 			// Cold liquids
 			vec3 localPos = fract(fragWorldPos.xyz / 512.0) * 512.0;
-			
+
 			// Foam
 			float intensity = clamp(dot(fragNormal, vec3(0, 1, 0)), 0, 1);
 			float a = localPos.x + localPos.y - 1.5 * flowVectorf.x * waterFlowCounter;
 			float b = localPos.z - 1.5 * flowVectorf.y * waterFlowCounter;
-			
+
 			float noise1 = gnoise(vec3(a*35, b*35, waterFlowCounter));
 			float noise2 = gnoise(vec3(a*2, b*2, waterFlowCounter));
-			
+
 			float diff = intensity * clamp(1 - diffTotal*1500 - noise1/2 + noise2/2, 0, 1);
 			float noise = intensity * (gnoise(vec3(a * 0.4, b * 0.4, waterFlowCounter))/2 + gnoise(vec3(a, b, waterFlowCounter))/2 + 0.5) / 2;
-			
+
 			float rgbAdd = max(0, bright*(diff * 0.3 + noise/10));
 			if (doLightFoam) {
 				rgbAdd /= 2;
 			}
 			texColor.rgb += vec3(rgbAdd, rgbAdd, rgbAdd);
 			texColor.a += max(0, diff/16 + noise/4);
-			
+#if VSMOD_SSR > 0
+			texColor.a *= VSMOD_SSR_WATER_TRANSPARENCY;
+#endif
 			
 			// Droplet noise
 			float f = 0;
 			if (skyExposed > 0) {
 				vec2 uv = localPos.xz * (12.0 / (2.0 + noise1/5000.0 + noise/600.0));
 				f = dropletnoise(uv);
+#if VSMOD_SSR > 0
+				f *= VSMOD_SSR_SPLASH_TRANSPARENCY;
+#endif
 			}
-			
-			
-			
-			// Specular reflection
-			if (skyExposed > 0) {
-				vec3 noisepos = vec3(localPos.x , localPos.z, waterWaveCounter / 8 + windWaveCounter / 6);
-				
-				//float dy = clamp(noise2 / 10, 0, 1) + gnoise(noisepos); - trippy specular rings
-				
-				float dy = noise2 / 20 + clamp(gnoise(noisepos) / 10, 0, 0.6);
-				
-				vec3 normal = normalize(vec3(dy, 1, -dy));
-				
-				float upness = max(0, dot(fragNormal, vec3(0,1,0))); // Only do specular reflections on up faces
-				
-				vec3 eye = normalize(vec3(fWorldPos.x, fWorldPos.y - 2, fWorldPos.z));
-				vec3 reflectionVec = reflect(sunPosRel, normal);
-				float p = dot(reflectionVec, eye);
-				if (p > 0) {
-					float sunb = clamp(sunPosRel.y * 10, 0, 1) * clamp(1.5 - sunPosRel.y, 0, 1) * sunSpecularIntensity;
-					
-					float specular = pow(p, 200) * sunb;
-					
-					#if SHADOWQUALITY > 0
-					float weight = upness * clamp(specular * clamp(pow(shadowBright, 4), 0, 1) * clamp(1.5 * shadowIntensity, 0, 1), 0, 1);
-					#else
-					float weight = upness * clamp(specular * clamp(pow(shadowBright, 4), 0, 1) * clamp(1.5, 0, 1), 0, 1);
-					#endif
-					
-					vec3 sunColf = applyFog(vec4(sunColor, 1), fogAmount).rgb;
-					
-					texColor.rgb = mix(texColor.rgb, sunColf + noise1 * 0.2, weight);
-					texColor.a = mix(texColor.a, texColor.a + specular/2, weight);
-				}
-			}
-			
+
 			texColor.rgb *= 1 + f;
-			
 		}
 	}
 	
